<div ng-controller="courses-units">

	<div class="info-panel">
		<div class="row">
			<div class="col-md-6">
				<div class="form-group">
					<label for="level" class="form-label">
						<i class="bi bi-stack"></i>
						{{labels.level}}
					</label>
					<select id="level" ng-model="level" class="form-select" placeholder="{{labels.level}}" ng-options="level.id as level.name for level in levels | orderBy : 'index'" placeholder="{{labels.level}}" ng-disabled="submitted" ng-change="updateLevel(true)">
						<option disabled="disabled" value="">-- اختر {{labels.level}} --</option>
					</select>
				</div>
			</div>
			<div class="col-md-6">
				<div class="form-group">
					<label for="course" class="form-label">
						<i class="bi bi-book"></i>
						{{labels.course}} الدراسية
					</label>
					<select id="course" ng-model="course" class="form-select" placeholder="{{labels.course}} الدراسية" ng-options="course.id as course.name for course in levelCourses | orderBy : 'index'" placeholder="{{labels.course}}" ng-disabled="submitted" ng-change="updateCourse()">
						<option disabled="disabled" value="">-- اختر {{labels.course}} --</option>
					</select>
				</div>
			</div>
		</div>
		<div class="help-text-enhanced">
			<small class="text-helper">
				<i class="bi bi-info-circle"></i>
				يجب اختيار {{labels.level}} و{{labels.course}} أولاً لتتمكن من إدارة الوحدات والدروس
			</small>
		</div>
	</div>
	
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>إدارة الوحدات</h3>
		<button class="btn btn-add" ng-click="addUnit(unitList.length)" ng-hide="submitted">
			<i class="bi bi-plus-lg"></i>
			إضافة وحدة جديدة
		</button>
	</div>
	
	<div class="parent-item list-fade-in" ng-repeat="(unitIndex, unit) in unitList track by $index">
		
		<div class="parent-header">
			<div class="parent-title-section">
				<div class="parent-number">
					<span class="list-item-counter">{{$index + 1}}</span>
				</div>
				<div class="parent-title-content">
					<i class="bi bi-collection"></i>
					الوحدة رقم {{$index + 1}}
				</div>
			</div>
			
			<div class="parent-controls">
				<div class="parent-actions" ng-hide="submitted">
					<button type="button" class="btn parent-action-btn btn-sm" ng-click="addUnit($index)" title="إضافة وحدة جديدة بعد هذه">
						<i class="bi bi-plus-lg"></i>
					</button>
					<button type="button" class="btn parent-action-btn btn-sm" ng-click="upUnit($index)" ng-if="$index != 0 && unitList.length != 1" title="نقل الوحدة لأعلى">
						<i class="bi bi-chevron-double-up"></i>
					</button>
					<button type="button" class="btn parent-action-btn btn-sm" ng-click="downUnit($index)" ng-if="$index != unitList.length - 1 && unitList.length != 1" title="نقل الوحدة لأسفل">
						<i class="bi bi-chevron-double-down"></i>
					</button>
					<button type="button" class="btn parent-action-btn btn-sm" ng-click="deleteUnit($index)" ng-if="unitList.length != 1" title="حذف الوحدة">
						<i class="bi bi-trash"></i>
					</button>
					<button type="button" class="btn parent-action-btn btn-sm" ng-click="addUnit($index + 1)" title="إضافة وحدة جديدة قبل هذه">
						<i class="bi bi-plus-lg"></i>
					</button>
				</div>
			</div>
		</div>

		<div class="parent-input-section">
			<div class="input-group parent-input-group">
				<span class="input-group-text parent-label">
					<i class="bi bi-collection"></i>
					اسم الوحدة
				</span>
				<input id="unit{{$index}}" name="units" ng-model="unit.name" type="text" class="form-control" required="required" maxlength="100" placeholder="اسم الوحدة" autocomplete="off" ng-disabled="submitted">
				<span class="input-group-text list-order">
					<i class="bi bi-sort-numeric-down"></i>
					{{$index + 1}}
				</span>
			</div>
		</div>

		<div class="childs-section">
			<div class="childs-header">
				<h5 class="childs-title">
					<i class="bi bi-door-open"></i>
					دروس الوحدة ({{unit.topics.length}})
				</h5>
				<button class="btn btn-add btn-sm" ng-click="addTopic(unit, unit.topics.length)" ng-hide="submitted">
					<i class="bi bi-plus-lg"></i>
					إضافة درس
				</button>
			</div>

			<div ng-show="unit.topics.length === 0" class="childs-empty-state">
				<i class="bi bi-door-closed childs-empty-icon"></i>
				<p class="childs-empty-text">لا توجد دروس في هذه الوحدة</p>
				<button class="btn btn-add btn-sm" ng-click="addTopic(unit, 0)">
					<i class="bi bi-plus-lg"></i>
					إضافة أول وحدة
				</button>
			</div>

			<div class="child-item" ng-repeat="topic in unit.topics track by $index">
				
				<div class="child-header">
					<div class="child-info">
						<div class="child-number">
							<span class="child-counter">{{$index + 1}}</span>
						</div>
						<div class="child-title">
							<i class="bi bi-journal-text"></i>
							درس رقم {{$index + 1}}
						</div>
					</div>
					
					<div class="child-actions" ng-hide="submitted">
						<button type="button" class="btn parent-action-btn btn-sm" ng-click="addTopic(unit, $index + 1)" title="إضافة درس جديد بعد هذا">
							<i class="bi bi-plus-lg"></i>
						</button>
						<button type="button" class="btn parent-action-btn btn-sm" ng-click="upTopic(unit, $index)" ng-if="$index != 0 && unit.topics.length != 1" title="نقل الدرس لأعلى">
							<i class="bi bi-chevron-up"></i>
						</button>
						<button type="button" class="btn parent-action-btn btn-sm" ng-click="downTopic(unit, $index)" ng-if="$index != unit.topics.length - 1 && unit.topics.length != 1" title="نقل الدرس لأسفل">
							<i class="bi bi-chevron-down"></i>
						</button>
						<button type="button" class="btn parent-action-btn btn-sm" ng-click="deleteTopic(unit, $index)" ng-if="unit.topics.length != 1" title="حذف الدرس">
							<i class="bi bi-trash"></i>
						</button>
						<button type="button" class="btn parent-action-btn btn-sm" ng-click="addTopic(unit, $index)" title="إضافة درس جديد قبل هذا">
							<i class="bi bi-plus-lg"></i>
						</button>
					</div>
				</div>

				<div class="child-input-section">
					<div class="input-group child-input-group">
						<span class="input-group-text child-label">
							<i class="bi bi-journal-text"></i>
							اسم الدرس
						</span>
						<input id="child-{{unitIndex}}-{{$index}}" name="childs-{{unitIndex}}" ng-model="topic.name" type="text" class="form-control" required="required" maxlength="100" placeholder="اسم الدرس" autocomplete="off" ng-disabled="submitted">
						<span class="input-group-text child-order">
							<i class="bi bi-hash"></i>
							{{$index + 1}}
						</span>
					</div>
					<div class="child-help-text">
						<small class="list-text-helper">
							<i class="bi bi-info-circle list-icon-sm"></i>
							أدخل اسماً واضحاً ومميزاً للدرس
						</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="form-controls" ng-hide="submitted">
		<div class="d-flex justify-content-center align-items-center gap-3">
			<button class="btn btn-add" ng-click="saveUnits()" ng-hide="loading">
				<i class="bi bi-floppy"></i>
				حفظ جميع الوحدات والدروس
			</button>
			<div ng-show="submitted" class="d-flex align-items-center" ng-show="loading">
				<div class="spinner-border ms-2"></div>
				<span>جاري الحفظ...</span>
			</div>
		</div>
	</div>

</div>