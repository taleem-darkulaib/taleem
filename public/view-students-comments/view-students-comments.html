<div ng-controller="view-students-comments">

	<div class="info-panel">
		<div class="row">
			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="cpr-search" class="form-label">
						<i class="bi bi-person-badge"></i>
						الرقم الشخصي
					</label>
					<div class="input-group">
						<span class="input-group-text">
							<i class="bi bi-person-badge"></i>
						</span>
						<input id="cpr-search" ng-model="search.cpr" type="tel" class="form-control cpr" placeholder="الرقم الشخصي" maxlength="9" autocomplete="off" ng-change="searchStudents()">
					</div>
				</div>
			</div>
			
			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="name-search" class="form-label">
						<i class="bi bi-person"></i>
						اسم الطالب
					</label>
					<div class="input-group">
						<span class="input-group-text">
							<i class="bi bi-person"></i>
						</span>
						<input id="name-search" ng-model="search.name" type="text" class="form-control name" placeholder="اسم الطالب" maxlength="50" autocomplete="off" ng-change="searchStudents()">
					</div>
				</div>
			</div>
			
			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="mobile-search" class="form-label">
						<i class="bi bi-phone"></i>
						رقم الهاتف
					</label>
					<div class="input-group">
						<span class="input-group-text">
							<i class="bi bi-phone"></i>
						</span>
						<input id="mobile-search" ng-model="search.mobile" type="tel" class="form-control mobile" placeholder="رقم الهاتف" maxlength="8" autocomplete="off" ng-change="searchStudents()">
					</div>
				</div>
			</div>
			
			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="grade-search" class="form-label">
						<i class="bi bi-mortarboard"></i>
						الصف الدراسي
					</label>
					<select id="grade-search" ng-model="search.grade" class="form-select" placeholder="الصف الدراسي" ng-options="grade.id as grade.name for grade in grades" ng-change="searchStudents()">
						<option value="">جميع الصفوف</option>
					</select>
				</div>
			</div>

			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="level-search" class="form-label">
						<i class="bi bi-mortarboard-fill"></i>
						{{labels.level}}
					</label>
					<select id="level-search" ng-model="search.level" class="form-select" placeholder="{{labels.level}}" ng-options="level.id as level.name for level in values(levels) | orderBy:'index'" ng-change="searchStudents()">
						<option value="">{{labels.level}}</option>
					</select>
				</div>
			</div>
			
			<div class="col-md-6 col-lg-4">
				<div class="form-group">
					<label for="type-search" class="form-label">
						<i class="bi bi-tags"></i>
						نوع الملاحظة
					</label>
					<select id="type-search" ng-model="search.type" class="form-select" placeholder="نوع الملاحظة" ng-change="searchStudents()">
						<option value="">نوع الملاحظة</option>
						<option value="حسن سلوك">حسن سلوك</option>
						<option value="ملاحظة أكاديمية">ملاحظة أكاديمية</option>
						<option value="اشعار سلوكي">اشعار سلوكي</option>
					</select>
				</div>
			</div>
		</div>
	</div>
	
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>قائمة الملاحظات</h3>
		<button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#uploadModal" ng-hide="submitted">
			<i class="bi bi-check-circle"></i>
			رفع ملاحظات
		</button>
	</div>
	
	<div class="table-responsive">
		<table id="comments" class="table table-striped">
			<thead>
				<tr>
					<th>
						<i class="bi bi-hash"></i>
					</th>
					<th>
						<i class="bi bi-person-badge"></i>
						الرقم الشخصي
					</th>
					<th>
						<i class="bi bi-person"></i>
						اسم الطالب
					</th>
					<th>
						<i class="bi bi-mortarboard-fill"></i>
						{{labels.level}}
					</th>
					<th>
						<i class="bi bi-person-check"></i>
						الملاحظ
					</th>
					<th>
						<i class="bi bi-tags"></i>
						النوع
					</th>
					<th>
						<i class="bi bi-chat-text"></i>
						الملاحظة
					</th>
					<th>
						<i class="bi bi-calendar"></i>
						التاريخ
					</th>
					<th class="no-export">
						<i class="bi bi-gear"></i>
						الإجراءات
					</th>
				</tr>
			</thead>
			<tbody>

				<tr ng-repeat="comment in matchedComments | orderBy : 'id' track by $index">
					<td>
						<div class="counter-badge counter-badge-sm">{{$index + 1}}</div>
					</td>
					<td>
						{{comment.cpr}}
					</td>
					<td>
						{{students[comment.cpr].name}}
					</td>
					<td>
						{{levels[comment.level].name}}
					</td>
					<td>
						{{comment.applicant}}
					</td>
					<td>
						<div class="status-badge" 
							 ng-class="{
								'status-badge-error': comment.type == 'اشعار سلوكي',
								'status-badge-warning': comment.type == 'ملاحظة أكاديمية',
								'status-badge-completed': comment.type == 'حسن سلوك'}">
							<i class="bi" ng-class="{
								'bi-x-circle-fill': comment.type == 'اشعار سلوكي',
								'bi-clock-fill': comment.type == 'ملاحظة أكاديمية',
								'bi-check-circle-fill': comment.type == 'حسن سلوك'}"></i>
							{{comment.type}}
						</div>
					</td>
					<td>
						<div class="info-panel">
							<small class="text-helper">
								<i class="bi bi-chat-text"></i>
								<span ng-bind-html="comment.content"></span>
							</small>
						</div>
					</td>
					<td>
						{{comment.time}}
					</td>
					<td class="text-center no-export">
						<button class="btn btn-delete btn-sm" data-bs-toggle="modal" data-bs-target="#deleteCommentModal" ng-click="selectComment(comment)" ng-if="isStringNotEmpty(comment.id)">
							<i class="bi bi-trash"></i>
							حذف
						</button>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	
	<a id="download" ng-href="{{href}}" download="{{download}}"></a>
	
	<div class="form-controls fade-in" ng-hide="submitted">
		<button class="btn btn-primary" ng-click="exportToExcel()" ng-hide="loading">
			<i class="bi bi-download"></i>
			حفظ ملاحظات الطالب
		</button>
	</div>
	
	<div id="deleteCommentModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<div class="modal-logo">
							<i class="bi bi-exclamation-triangle"></i>
						</div>
						حذف ملاحظة الطالب
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="deletion-warning">
						<div class="warning-content">
							<h4 class="warning-title">تأكيد الحذف</h4>
							<p class="warning-text">
								هل أنت متأكد من حذف ملاحظة الطالب <strong>{{students[comment.cpr].name}}</strong>؟
							</p>
							<div class="warning-note">
								<i class="bi bi-info-circle"></i>
								<strong>تنبيه:</strong> لا يمكن التراجع عن هذا الإجراء
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer" ng-hide="submitted">
					<button type="button" class="btn btn-delete" data-bs-dismiss="modal" ng-click="deleteComment()">
						<i class="bi bi-trash"></i>
						تأكيد الحذف
					</button>
					<button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">
						<i class="bi bi-x-circle"></i>
						إلغاء
					</button>
				</div>
			</div>
		</div>
	</div>
	
	<div id="uploadModal" class="modal fade" tabindex="-1">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="bi bi-check-circle"></i>
						رفع ملاحظات الطلبة
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					
					<div class="form-group">
						<label for="type" class="form-label">
							<i class="bi bi-cloud-upload"></i>
							رفع الملاحظات
						</label>
						<input id="file" type="file" class="form-control" accept=".xlsx" placeholder="الملاحظات" ng-disabled="submitted">
						<div class="help-text-enhanced">
							<small class="text-helper">
								<i class="bi bi-info-circle"></i>
								يدعم ملفات Excel (.xlsx) بنفس ترتيب الأعمدة
							</small>
						</div>
					</div>

					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<tr>
									<th>
										<i class="bi bi-hash"></i>
									</th>
									<th>
										<i class="bi bi-person-badge"></i>
										الرقم الشخصي
									</th>
									<th>
										<i class="bi bi-person"></i>
										اسم الطالب
									</th>
									<th>
										<i class="bi bi-mortarboard-fill"></i>
										{{labels.level}}
									</th>
									<th>
										<i class="bi bi-tags"></i>
										النوع
									</th>
									<th>
										<i class="bi bi-chat-text"></i>
										الملاحظة
									</th>
								</tr>
							</thead>
							<tbody>

								<tr ng-repeat="comment in uploadedComments track by $index">
									<td>
										<div class="counter-badge counter-badge-sm">{{$index + 1}}</div>
									</td>
									<td>
										{{comment.cpr}}
									</td>
									<td>
										{{students[comment.cpr].name}}
									</td>
									<td>
										{{levels[comment.level].name}}
									</td>
									<td>
										<div class="status-badge" 
											 ng-class="{
												'status-badge-error': comment.type == 'اشعار سلوكي',
												'status-badge-warning': comment.type == 'ملاحظة أكاديمية',
												'status-badge-completed': comment.type == 'حسن سلوك'}">
											<i class="bi" ng-class="{
												'bi-x-circle-fill': comment.type == 'اشعار سلوكي',
												'bi-clock-fill': comment.type == 'ملاحظة أكاديمية',
												'bi-check-circle-fill': comment.type == 'حسن سلوك'}"></i>
											{{comment.type}}
										</div>
									</td>
									<td>
										<div class="info-panel">
											<small class="text-helper">
												<i class="bi bi-chat-text"></i>
												<span ng-bind-html="comment.content"></span>
											</small>
										</div>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					
				</div>
				<div class="modal-footer d-print-none">
					<button class="btn btn-add" ng-click="saveUploadedComments()" data-bs-dismiss="modal" ng-disabled="uploadedComments.length == 0">
						<i class="bi bi-floppy"></i>
						حفظ الملاحظات
					</button>
					<button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">
						<i class="bi bi-x-lg"></i>
						غلق
					</button>
				</div>
			</div>
		</div>
	</div>
	
</div>